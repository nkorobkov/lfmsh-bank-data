---
title: "Анализ данных экономической игры ЛФМШ-30"
author: "Никита Коробков | nikkorobk@gmail.com"
email: nikkorobk@gmail.com
date: "9/23/2017"
output:
  html_document:
    toc: yes
    toc_depth: 6
  pdf_document:
    keep_tex: yes
    toc: yes
    toc_depth: 4
header-includes:
urlcolor: blue
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(psych)
library(plotly)
library(RColorBrewer)


Sys.setlocale("LC_CTYPE", "ru_RU")

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width=9, cache=TRUE)
```

```{r data_load, include=FALSE, cache=TRUE}
students = as_data_frame(read.csv('../data/student_features.csv'))
time = as_data_frame(read.csv('../data/time_features.csv'))
type = as_data_frame(read.csv('../data/type_features.csv'))
money = read.csv('../data/money.csv',sep=',', stringsAsFactors=FALSE, encoding = "UTF-8")
counters = read.csv('../data/counters.csv',sep=',', stringsAsFactors=FALSE, encoding = "UTF-8")

```
## Вступление
В августе 2017 года прошла 30-ая смена [Летней Физико-Математической Школы](http://lfmsh.ru/). В смене традиционно проводится экономическая игра, в ходе которой слушателям школы за положительную активность начисляется виртуальная валюта (баксы или **\@**). В течение смены баксы можно тратить на покупку чего-либо (от книг до шаурмы). В результате разных финансовых операций у нас собралось внушительное количество данных о всех перемещениях виртуальных баксов в смене.  
Давайте попробуем проанализировать эти данные.

## Знакомство с Пионерами
### Анализ суммарного заработка пионеров

```{r earnings_list}
earnings_list = as.data.frame(students["Заработано.за.смену"])[,1]
```

Всего в лагерь приехали `r length(students$username)` слушателей, которые закончили `r min(students$grade)`–`r max(students$grade)` класс. Известно количество виртуальных денег, которое заработал каждый слушатель в течение смены. Всего слушатели заработали **`r format(round(sum(earnings_list)))`\@**, в среднем на человека пришлось по **`r round(mean(earnings_list))`\@**, самый богатый пионер накопил **`r round(max(earnings_list))`\@**, а самый бедный только **`r round(min(earnings_list))`\@**.   
Ниже представлена гистограмма, отражающая заработок слушателей.


```{r all_students_hist}
ggplot(students, aes(x = `Заработано.за.смену`)) + 
  geom_histogram(bins = 40, fill='#56B4E9', col = '#0072B2', alpha=0.3) +
  geom_vline(xintercept = mean(earnings_list), col='#E69F00') +
  scale_x_continuous('Заработок за смену',breaks = function(x) seq(floor(min(x)/50)*50, max(x),50)) + 
  scale_y_continuous('Количество пионеров', breaks = seq(0, 10, 1)) + 
  ggtitle("Распределение суммарного заработка за смену")
sel = shapiro.test(earnings_list[earnings_list < 1100])
```
Несмотря на то, что визуально распределение заработка по пионерам слабо отличается от нормального, считать его нормальным мы не можем из-за трех значений в самой правой части графика. Эти значения слишком сильно отклоняются от среднего, из-за чего мы не можем принять гипотезу о нормальности распределения. Если же выкинуть эти значения, то оставшиеся будут распределены вполне себе нормально (Значение p-value для теста Шапиро-Уилка = `r sel$p.value`).

Временно уберем трех самых богатых пионеров из выборки и построим такие же гистограммы, разделив пионеров на группы по классам (7–10). Нормальность распределения внутри группы сохраняется. Значения p-value для теста Шапиро-Уилка по классам приведены в таблице.

```{r shapiro_by_grade}
d = function(earnings) shapiro.test(earnings)$p.value

by_grade = students %>%
  filter(grade < 11, `Заработано.за.смену` < 1100)%>%
  mutate(grade = factor(grade)) %>%
  group_by(grade) %>%
  mutate(mean_in_grade = mean(`Заработано.за.смену`), min_in_grade = as.numeric(mean_cl_boot(`Заработано.за.смену`)['ymin']), max_in_grade = as.numeric(mean_cl_boot(`Заработано.за.смену`)['ymax']))

s2 = by_grade %>%
  group_by(grade) %>%
  summarise( Shapiro_test_p_value = d(`Заработано.за.смену`))
s22 = t(s2$Shapiro_test_p_value)
colnames(s22) = s2$grade
a2 = data.frame(Класс = c('p-value'))
s22 = cbind(a2,s22)

knitr::kable(s22, caption = 'Значения p-value для теста Шапиро-Уилка при делении на группы по классу')

```

На гистограммах оранжевым отмечено среднее значение заработка по всей выборке, а красным – внутри группы. Красным пунктиром выделены доверительные интервалы среднего значения. 11-ый класс закончили всего два слушателя, поэтому их мы рассматривать не будем.


```{r by_grade_plot}


ggplot(by_grade, aes(x = `Заработано.за.смену`,group=grade)) + 
  geom_histogram(bins=30, fill='#56B4E9', col = '#0072B2', alpha=0.3) +
  geom_vline(aes(xintercept = mean(earnings_list[earnings_list<1100])),  col='#E69F00') +
  facet_grid(grade~.)  + 
  geom_vline(aes(xintercept = mean_in_grade, group = grade),  col='#D55E00') +
  geom_vline(aes(xintercept = min_in_grade,  group = grade),linetype="dashed",  col='#D55E00') +
  geom_vline(aes(xintercept = max_in_grade, group = grade),linetype="dashed",  col='#D55E00') + 
  scale_x_continuous('Заработок за смену',breaks = function(x) seq(floor(min(x)/50)*50, max(x),50)) + 
  scale_y_continuous('Количество пионеров', breaks = seq(0, 10, 1))+ 
  ggtitle("Распределение суммарного заработка за смену по классам")
```

Из графиков видно что средний заработок 10 класса значимо отличается от среднего заработка 8 и 9 классов.

### Составляющие успеха

Для каждого слушателя собрана статистика не только о суммарном заработке за смену, но и о заработке в отдельных категориях: «Учебная деятельность», «Участие в мероприятиях», «Посещение зарядки», «Чистка картошки» и другие. Посмотрим, как могут быть связаны между собой эти показатели.

Всего для каждого слушателя собрано более 70 различных показателей. Разумеется, большинство пар измерений никак не связаны между собой и рассматривать их нет смысла.

Выберем несколько интересующих нас областей и ограничимся рассмотрением связей внутри них.

1. Связь неденежных показателей с суммарным заработком и заработком в связанных категориях. 
2. Связь разных направлений учебной деятельности. 
3. Связь факта покупки книги с категориями заработка
4. Связь заработка за спорт с заработком за учебу


#### Связь неденежных показателей с суммарным заработком

Существует 11 показатели, которые не связаны с деньгами напрямую. Это счетчики посещений и пропусков для лекций, лабораторий, факультативов, зарядок, семинаров и сертификатов на книжки.

На самом деле, большинство этих величин так или иначе все-таки связаны с заработком. Например, посещение лаборатории всегда означает денежное вознаграждение за сдачу отчета. Только два показателя действительно не связаны с заработком напрямую – **посещение семинаров** и **посещение зарядки**. За посещение семинаров слушатели не получают денег совсем, а за зарядку хоть и платят, но настолько мало, что существенного вклада в общую картину эта сумма внести не может.
##### Связь количества посещенных семинаров с суммарным заработком

Отложим на графике по оси X количество посещенных семинаров, а по Y все ту же сумму заработанных за смену денег. 

```{r sem_no_smooth}
ggplot(students, aes(x = `Счетчик.Посещение.семинара`, y = `Заработано.за.смену`))+
  geom_point(col = '#0072B2') + 
  scale_y_continuous('Заработок за смену',breaks = function(x) seq(floor(min(x)/50)*50, max(x),50)) + 
  scale_x_continuous('Количество посещенных семинаров', breaks = seq(0, 20, 1)) + 
  theme_minimal()+ 
  ggtitle("Влияние посещения семинаров на суммарный заработок")
```

Можно заметить небольшой ниcходящий тренд. Но может быть нам только кажется ?
Давайте построим линейную модель. 

```{r sem_model}
fit = lm(earn~Количество_посещенных_семинаров, data=select(students,earn = `Заработано.за.смену`, Количество_посещенных_семинаров = `Счетчик.Посещение.семинара` ))
sf = summary(fit)

knitr::kable (sf["coefficients"], caption = 'Параметры линейной модели зависимости заработка за смену от количества посещенных семинаров')
```

Действительно, мы видим, что p-value для количества семинаров меньше 0.05, значит, можно утверждать, что посещение семинаров влияет на суммарный заработок. Как видно из коэффициентов модели, каждый посещенный семинар в среднем на 8@ уменьшает заработок пионера.

Это объясняется тем, что за семинары не платят денег, но вместо того, чтобы слушать семинары, можно пойти на факультатив или сделать лабу. В среднем за факультатив на протяжении смены слушатель получал по **`r round( mean(as.data.frame(students['Зачет.по.факультативу'])[,1]/as.data.frame(students['Счетчик.Посещение.факультатива'])[,1], na.rm = TRUE), 2)`\@** что как раз попадает в доверительные интервалы коэффициента при семинарах в линейной модели (- 8.5 +- 3.5).

Еще более явно эту взаимосвязь можно проследить, если построить зависимость заработанных за учебу денег от количества посещенных семинаров. Построим такой график, а заодно отобразим на нем линию тренда, предсказанную линейной моделью.

```{r sem_with_lm}

ggplot(students, aes(x = `Счетчик.Посещение.семинара`, y = `Общие.Учеба`, col = `Заработано.за.смену`))+  
  geom_point() +
  scale_colour_gradientn(colours=topo.colors(3)) +
  geom_smooth(method = 'lm', se = FALSE) + 
  scale_y_continuous('Заработок за Учебу',breaks = function(x) seq(floor(min(x)/50)*50, max(x),50)) + 
  scale_x_continuous('Количество посещенных семинаров', breaks = seq(0, 20, 1)) + 
  theme_minimal()+ 
  ggtitle("Влияние посещения семинаров на заработок за учебу")

  
fit = lm(earn~Количество_посещенных_семинаров, data=select(students,earn = `Общие.Учеба`, Количество_посещенных_семинаров = `Счетчик.Посещение.семинара` ))
ps = summary(fit)$coefficients[2,4] 
ks = summary(fit)$coefficients[2,1] 

```

Видим что 

1. Заработок за учебу сильно коррелирует с заработком за смену, что не удивительно. 
2. Заработок за учебу еще сильнее подвержен влиянию количества посещенных семинаров. В этой модели каждый посещенный семинар уменьшает ожидаемый заработок за учебу уже на целых **`r round(ks, 2)`\@**. 


##### Связь количества посещенных зарядок с суммарным заработком

Для начала проверим, ходил ли кто-нибудь вообще на зарядку в этой смене. 

```{r workout_hist}
ggplot(students, aes(x = `Счетчик.Зарядка`)) + 
  geom_histogram(bins = 15, fill='#56B4E9', col = '#0072B2', alpha=0.3) +
  scale_x_continuous('Посещения зарядки',seq(0, 14, 1)) + 
  scale_y_continuous('Количество пионеров', breaks = seq(0, 70, 5))+ 
  theme_minimal()+ 
  ggtitle("Распределение посещений зарядки")
```

Больше половины пионеров на зарядке не появились ни разу. Зато из тех, кто продержался и не бросил ходить после первых двух раз, больше половины посещали зарядку до конца смены (>10 раз).

Построим ящики с усами, чтобы проверить, есть ли какие-нибудь значимые различия между мощными парнями и девчонками, которые сходили на зарядку три и более раз, и остальными слушателями. 


```{r workout boxplot}
students = mutate(students, hard_workout = as.factor(`Счетчик.Зарядка`>=3))
ggplot(students, aes(x =hard_workout, y = `Заработано.за.смену`))+  
  geom_boxplot(fill='#56B4E9', alpha=0.3) + 
  scale_x_discrete("Посещения зарядки", labels = c("TRUE" = ">= 3", "FALSE" = "<3")) + 
  theme_minimal()+ 
  ggtitle("Заработок за смену в зависимости от посещений зарядки")

  
fit = aov(`Заработано.за.смену`~hard_workout, students)
ps_earn = summary(fit)[[1]][[5]][1]

  
fit = aov(`Общие.Спорт`~hard_workout, students)
ps_sport = summary(fit)[[1]][[5]][1]
```

К сожалению, явных различий нет. Коэффициенты дисперсионного анализа подтверждают отсутствие взаимосвязи. При сравнении общего заработка p-value = `r round(ps_earn,digits=3)`, а при сравнении заработка только за спорт p-value = `r round(ps_sport,digits=3)`.

#### Связь разных направлений учебной деятельности

В лагере существует много способов получить новые знания. Как мы уже выяснили, посещение большого количества семинаров отрицательно влияет на общий заработок за учебу, а как на счет остальных областей? Есть ли связь между различными учебными активностями?

Деньги за учебу начислялись в семи категориях. Для того, чтобы выяснить, какие из этих категорий действительно связаны между собой, посмотрим на значения p-value для коэффициентов корреляции Пирса между всеми парами.

_Нулевая гипотеза здесь говорит о том что коэффицент корреляции = 0_


```{r study_cor_p}
cor_res = corr.test(select(students, Кружки = `Зачет.по.кружку`, Факультативы = `Зачет.по.факультативу`, Лабы =  `Лабораторная.работа`,Олимпиады = `Олимпиада`,Проведение_семинара = `Проведение.семинара`,Решение_убойных_задач  = `Решение.убойных.задач`,`Экзамен`))

knitr::kable(cor_res$p, caption = "Значения p-value")
```

Из таблицы видно, что почти все переменные (за исключением, разве что, Кружков и Семинаров) значимо коррелируют между собой. Отбросим неинтересные слабо коррелирующие показатели и выведем значения самого коэффициента корреляции для оставшихся пар.

```{r study_cor_r}
study_info= select(students, Факультативы = `Зачет.по.факультативу`, Лабы =  `Лабораторная.работа`,Олимпиады = `Олимпиада`,Решение_убойных_задач  = `Решение.убойных.задач`,`Экзамен`)
cor_res2 = corr.test(study_info)
knitr::kable(cor_res2$r, caption = "Коэффицент корреляции Пирса для доходов за учебу")
```


Все корреляции положительные. Это неудивительно, потому что те, кто много ботают, ботаю во всех категориях. Построим пару графиков, чтобы проиллюстрировать этот незатейливый факт.

```{r study_graphs}
  
ggplot(study_info, aes(x = Факультативы, y = Олимпиады, size = Решение_убойных_задач)) + 
  geom_point(fill='#56B4E9', alpha=0.6, col = '#0072B2') + 
  theme_minimal()+ 
  ggtitle("Успех в олимпиадах и убойках от суммы за факультативы")
```

```{r study_graphs_2}

ggplot(study_info, aes(x = Экзамен, y = Лабы)) + 
  geom_point(fill='#56B4E9', alpha=0.9 , col = '#b24000' ) + 
  geom_smooth(method = 'lm', formula = y~splines::bs(x, 3), se = FALSE) + 
  theme_minimal()+ 
  ggtitle("Сумма за лабы от резульатов экзамена и квадратичная модель")


```

_Слушатели, которые хорошо пишут экзамен, чаще всего выполняют больше лаб, чем необходимо._


#### Связь факта покупки книги с категориями заработка

Существует как минимум три основных пути потратить деньги в лагере. 

1. Купить книжку
2. Заказать что-то из магазина в городе
3. Купить лот на аукционе

Посмотрим, определяет ли то, откуда деньги появились, то, на что они будут потрачены.

```{r source1}


spendings_info= select(students, Книжки = `Покупка.книг`, Магазин =  `Покупка.товаров`,Аукцион = `Покупка.на.аукционе`,Услуги  = `Покупка.услуг`,starts_with("Общие")) %>%
  mutate(Купил_книжку = factor(Книжки<0))

ggplot(spendings_info, aes(x = Общие.Мероприятие, y = Общие.Спорт, col=Купил_книжку)) + 
  geom_point(fill='#56B4E9', alpha=0.9) + 
    scale_y_continuous('Заработок за Спорт',breaks = function(x) seq(floor(min(x)/50)*50, max(x),50)) + 
  scale_x_continuous('Заработок за Мероприятия',breaks = function(x) seq(floor(min(x)/50)*50, max(x),50)) + 
  scale_fill_discrete("Купил книжку", labels = c("TRUE"="Да","FALSE"="Нет")) + 
  theme_minimal()
```
```{r plots_for_spendings2, fig.width=3.5, fig.height=3}

ggplot(spendings_info, aes(x = Общие.Мероприятие,  col=Купил_книжку)) + 
  geom_density(alpha=0.9) + 
    guides(col=FALSE) + 
    scale_x_continuous('Заработок за Мероприятия',breaks = function(x) seq(floor(min(x)/50)*50, max(x),50)) + 
    scale_y_continuous('Плотность') + 
  theme_minimal()


ggplot(spendings_info, aes(x = Общие.Спорт,  col=Купил_книжку)) + 
  geom_density(alpha=0.9) + 
      guides(col=FALSE) + 
  scale_x_continuous('Заработок за Спорт',breaks = function(x) seq(floor(min(x)/50)*50, max(x),50)) + 
  scale_y_continuous('Плотность') + 
  theme_minimal() + 
  ggtitle("Спорт, Мероприятия и Книжки")
```

По графикам сложно сделать какие-либо определенные выводы. С одной стороны, почти все богатые слушатели купили книжку. С другой стороны, не очевидно, что здесь является причиной, а что следствием. Возможно, слушатели купили книгу, потому что не нашли большому количеству денег лучшего применения, а не специально старались заработать больше, чтобы купить книгу. В любом случае, мы советуем покупать книжки, это клево. 

#### Связь заработка за спорт с заработком за учебу

Да, здесь происходит именно то, что можно предугадать заранее. Чем больше слушатель заработал на спорте, тем меньше он получил за учебу. В среднем один спортивный бакс = -2 учебным. И зарядка тут ни при чем.


```{r  stud_sport, fig.width=9}
fit = lm(`Общие.Учеба`~Заработок_за_спорт, students %>% mutate(Заработок_за_спорт = `Общие.Спорт`))
sf = summary(fit)$coefficients
knitr::kable(sf, caption = "Коэффиценты линейной модели предсказания заработка за учебу по заработку за спорт")

ggplot(students, aes(x = Общие.Учеба, y = Общие.Спорт)) + 
  geom_point(alpha=0.9, aes( color=hard_workout)) + 
  geom_smooth(method = 'lm')+
  scale_color_discrete(name = "Посещения Зарядки", labels=c("FALSE" ="<3","TRUE"=">=3")) + 
  scale_y_continuous('Заработок за спорт',breaks = function(x) seq(floor(min(x)/50)*50, max(x),50)) + 
  scale_x_continuous('Заработок за учебу',breaks = function(x) seq(floor(min(x)/50)*50, max(x),50)) + 
  theme_minimal()+ ggtitle("Зависимость заработка за спорт от заработка за учебу")
  
```


### Общие тренды

В заключении главы про слушателей ЛФМШ и категории их заработка, попробуем выделить основные тенденции связи заработка в различных категориях.
Выделим четыре основных непересекающихся источника дохода и посмотрим как связаны между собой показатели пионеров по этим измерениям.


```{r pairs}

inter = select(students, starts_with("Общие"),  -`Общие.Технические.Типы`,-`Общие.Другое`, -`Общие.Переводы`,  -`Общие.Штрафы`, -`Общие.Покупка` )
colnames(inter) <- c("Мероприятия", "Работа", "Спорт", "Учеба")

pairs(inter, labels = c("Мероприятия", "Работа", "Спорт", "Учеба"), pch = 21,main = "Доход по основным статьям", bg = c('skyblue1'))

```


Видно, что переменные не совсем независимы и какая-то связь  между ними определенно есть. При помощи метода главных компонент попробуем найти две новые оси, которые объяснили бы максимум изменчивости данных, и построим график в новых осях.

```{r  prcomp}

PCbiplot <- function(PC, x="PC1", y="PC2") {
    # PC being a prcomp object
    data <- data.frame(PC$x)
    plot <- ggplot(data, aes_string(x=x, y=y, col=PC$earned)) + geom_point(alpha=.8, size=2)
    
    plot <- plot    + theme_minimal()+         
      scale_colour_continuous(name = "Общий заработок") + 
        scale_x_continuous('Главная компонента 1') + 
  scale_y_continuous('Главная компонента 2') 

    
    plot <- plot + geom_hline(yintercept = 0,  aes(0), size=.2) + geom_vline(xintercept = 0, aes(0), size=.2)
    datapc <- data.frame(varnames=rownames(PC$rotation), PC$rotation)
    mult <- min(
        (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
        (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
        )
    datapc <- transform(datapc,
            v1 = .7 * mult * (get(x)),
            v2 = .7 * mult * (get(y))
            )
    plot <- plot + coord_equal(ratio = 2) + geom_text(data=datapc, aes(x=v1, y=v2, label=varnames), size = 3, vjust=1, color="tomato")
    plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2), arrow=arrow(length=unit(0.2,"cm")), alpha=0.75, color="tomato")
    plot + ggtitle("Главные компоненты определяющие статьи дохода")
}

fit  = prcomp(inter)
fit$earned = students$`Заработано.за.смену`
sf= summary(fit)
PCbiplot(fit)

```

Полученные главные компоненты объясняют `r round(sf$importance[3,2] * 100, 2)`% изменчивости исходных данных, что неплохо. Из графика видно, что успех в Спорте почти обязательно связан с успехом на Мероприятиях и существенным доходом от работы. Кроме того, можно заметить, что самые богатые пионеры скорее сколотили свое состояние именно интеллектуальным трудом, нежели чем-то еще. При этом успехи в учебе очень слабо отрицательно коррелируют с доходом за спорт и работу, и совсем не связаны с величиной гонораров за победу в мероприятиях. Все эти чисто визуальные заключения подтверждаются значениями p-value для коэффициентов корреляции рассмотренных параметров.[^1] 

[^1]:Полные таблицы с коэффицентами представленны в приложении.

Чтобы окончательно закрыть вопрос связи рассматриваемых параметров, давайте построим линейную модель зависимости заработка за мероприятие от других трех величин.

```{r}
sf = summary(lm( Мероприятия~Спорт+Учеба+Работа,inter))

knitr::kable(sf$coefficients)

```

Все предикторы оказались значимыми, кроме, разве что, смещения.



## Денежные течения

В этой главе мы рассмотрим, откуда в основном брались деньги в лагере и на что они тратились (без привязки к конкретным слушателям).[^2]

[^2]:Информация по всем рассмотренным типам может быть найдена в приложении


```{r money_flow, fig.width = 10, fig.height=6}

mtype = type %>% 
  filter(type_readable_name != 'Общие Переводы')
mtype = mtype %>%
  mutate(profit = factor(mtype$total_value>0, labels = c("FALSE"="Расход","TRUE"="Доход"))) %>%
  mutate(sum_profit = sum(total_value[total_value>0]), sum_deficit = sum(total_value[total_value<0]) ) %>%
  mutate(percent_of_group = as.factor(round(abs(total_value*300/max(sum_profit, abs(sum_deficit))),digits=2 ) ))


gen_types = filter(mtype, grepl('Общие*', type_readable_name) &
                     type_readable_name != "Общие Технические Типы"&
                     type_readable_name != "Общие Учеба" |
                     type_readable_name == "Ежедневный налог"|
                     type_readable_name == "Частные Необязательная учебная программа"|
                     type_readable_name == "Частные Обязательная учебная программа"|
                     type_readable_name == "Начальное начисление") %>%
  arrange(-abs(total_value))

removeWords <- function(str) {
  x <- unlist(strsplit(str, " "))
  paste(x[!x %in% c("Общие", "Частные")], collapse = " ")
}

gen_types$label = factor(paste0(gen_types$percent_of_group, "% ", sapply(as.character(gen_types$type_readable_name), removeWords)), levels = paste0(gen_types$percent_of_group, "% ", sapply(as.character(gen_types$type_readable_name), removeWords)))


  

ggplot(gen_types, aes(x = profit, y = abs(total_value), fill=label, group = profit))+ 
  geom_bar(stat = "identity") +
  coord_flip() +
  scale_fill_brewer(palette="Set3",name = "Категория") + 
  theme_minimal() + 
  theme(legend.position = "top",legend.text=element_text(size=7) ,legend.title=element_text(size=8) ) +
  scale_y_continuous('Сумма', breaks = function(x) seq(floor(min(x)/5000)*5000, max(x),5000)) +
  scale_x_discrete('Тип') +
  ggtitle("Распределение @ по категориям")
  
```



Из графика видно, что сумма, выданная пионерам за прохождение обязательной учебной программы, почти равна сумме, снятой в виде подушного налога. Все остальные начисления, включая начальный капитал, пионеры потратили на покупки в магазине.  

Это немного расходится с изначально заложенной в экономическую игру формулой **Налоги = Начальное начисление + Обязательная учебная программа**. Получается, что ничего не делая сверх обязательных требований, можно не только досидеть до конца смены, но и накопить сумму примерно равную начальному начислению.  
В чем же дело?

### Обязательная-не-обязательная программа

Давайте посмотрим, из чего состоит обязательная учебная программа, и все ли начисления по этой статье действительно входили в обязательную программу.

```{r obl_study}

#distinct(money %>% filter(type_group_local == "Обязательная учебная программа") %>% select(type_readable_name) )
obl_std = mtype %>% filter(type_readable_name %in% c('Проведение семинара','Лабораторная работа','Зачет по факультативу','Экзамен')) %>% filter(mean_transaction > 2)


ggplot(obl_std, aes(x = type_readable_name, y = total_value))+ 
  geom_bar(stat="identity", col = 'olivedrab',fill='yellowgreen') +
  theme_minimal() + 
  scale_y_continuous('Сумма', breaks = function(x) seq(floor(min(x)/1000)*1000, max(x),1000)) +
  scale_x_discrete('Подкатегория обязательной учебной программы') +
  ggtitle("Распределение @ за обязательную учебную программу")
  
```

Каждый пионер за смену обязан провести один семинар, сдать два экзамена по лекциям и сделать две лабораторных работы. Если слушатель закончил девятый класс, то ему необходимо также сдать зачет по факультативу, если не закончил – сделать дополнительную, третью, лабу.

Сдать экзамен больше двух раз, как ни крути, не получится. Провести больше одного семинара можно, но занимаются этим, как правило, не больше одного-двух человек за смену. С факультативами и лабами дела обстоят иначе.

Давайте выясним, сколько зачетов за факультатив и отчетов по лабам сдавались не из-за необходимости выполнять программу, а сверх нормы.

#### Семинары
```{r fac_res}
fac = money %>% 
  filter(type_readable_name == 'Зачет по факультативу')%>%
  group_by(receiver_username) %>%
  summarise(count = n(), total = sum(value), mean = mean(value), grade = first(receiver_grade)) 
fac = fac %>%
  mutate(needed = as.numeric(grade > 8), extra = count - needed, extra_money = extra*mean)
```

**`r sum(fac$needed)`** слушатель в этой смене закончил 9-ый или 10-ый класс, однако зачетов по факультативам было сдано **`r sum(fac$count)`** – почти по два зачета на человека (напомним, что всего в лагере было 100 пионеров). Среднее начисление за зачет составило **`r round(mean(fac$mean), digits = 2)`\@**. В итоге, по статье «Обязательная учебная программа» за дополнительные зачеты по факультативу было получено **`r round(sum(fac$extra_money))`\@** [^3] – больше половины выданных за факультативы денег. Эту сумму можно смело перенести в статью «Необязательная учебная программа», так как никто не заставлял слушателей так активно посещать факультативы.

[^3]: Для расчета этого показателя мы для каждого перевыполнившего план пионера умножили его средний заработок за факультативы на количество "лишних" зачетов. Такой способ вычисления является более точным и сумма немного отличается от среднего за зачет умноженного на лишние зачеты. По факту выходит что каждый лишний зачет стоил немного меньше среднего, вероятно из-за того что лишние зачеты часто получали по факультативам идущим только половину смены. 

#### Лабораторные работы


С лабораторными работами можно провести те же самые выкладки. В таблице ниже приведены полученные результаты.

```{r lab}
lab = money %>% 
  filter(type_readable_name == 'Лабораторная работа')%>%
  group_by(receiver_username) %>%
  summarise(count = n(), total = sum(value), mean = mean(value), grade = first(receiver_grade)) 
lab = lab %>%
  mutate(needed = as.numeric(grade <= 8) + 2, extra = count - needed, extra_money = extra*mean)

lab_res = lab %>% summarise(`Нужно было сделать` = sum(needed),`Сделали` = sum(count),`Средний заработок за одну (@)` = round(mean(mean), digits = 2), `Дополнительные деньги за лишние лабы (@)` = sum(extra_money))

knitr::kable(lab_res, caption = "Статистика по сделанным в лагере лабораторным работам")
```

Итого, более **8000\@**, которые относятся к категории «Обязательная учебная программа», на самом деле не являлись обязательными. Получается, что если пионер не будет делать ничего сверх нормы, то у него останется **50\@** – на **80\@** меньше, чем мы предположили в начале главы.


### Покупательная способность собаки

Посмотрим теперь на что тратились деньги. И попробуем установить реальный курс бакса к рублю. 

```{r purchase}

#distinct(money %>% filter(type_group_general == "Покупка") %>% select(type_readable_name) )
purchase = mtype %>% filter(type_readable_name %in% c('Покупка книг','Покупка услуг','Покупка товаров','Покупка на аукционе'))
purchase_m = money %>% filter(type_readable_name %in% c('Покупка товаров','Покупка на аукционе'))


ggplot(purchase, aes(x = type_readable_name, y = -total_value))+ 
  geom_bar(stat="identity", col = 'olivedrab',fill='yellowgreen') +
  theme_minimal() + 
  scale_y_continuous('Сумма', breaks = function(x) seq(floor(min(x)/1000)*1000, max(x),1000)) +
  scale_x_discrete('Подкатегория траты') +
  ggtitle("Распределение категорий трат")
  
```

Книги в нашем магазине продавались 1:1 к рублю. По категории «услуги» проходили только отрядные фотографии, курс которых к рублю был такой же – 1:1. Остальное же оценить сложнее.
  
Привезенные из городских магазинов товары, как правило, продавали по курсу 1 рубль :1.5@. Однако, к этой категории относятся еще и 2 путевки в следующую смену, которые были проданы в сумме за 10К@ [^4]. Эти же 10К@ составляют больше половины общей суммы, потраченной в категории «товары».
  

Еще сложнее оценить коэффицент для аукциона. Нету такой цифры, которая могла бы в рублях отразить ценность обеда за столом педсостава.  
Установим курс за аукцион как 3:1, а товары поделим на 2 части. За путевки установим курс 2:1 (по той же логике что и аукцион), а за все остальное -- 1:1.5.  

Тогда, вычисляя общую покупательную способность @ в рублях получим следующее:

    Книги**/1 +  Аукцион * 3 +  Путевка * 2 + Товары/1.5 + Услуги/1 = 
    Сумма в рублях = 
    11577/1 + 6256 * 3 + 9900 * 2 + 7983/1.5 + 750/1 =  
    56217 ₽ 

**56217₽** реальных денег было необходимо чтобы обеспечить **`r abs(sum(purchase$total_value))`\@** единиц игровой валюты.   
Таким образом получаем реальный курс рубля к @ -- **1.54 рубля за бакс!** (или 0.65@ за рубль)

[^4]:Путевки в лагерь на следующую смену ушли с аукциона за 5000@ и 4900@. Покупка путевки на аукционе дает право поехать в лагерь без вступительных испытаний. Но основная ее ценность не в этом – купив путевку на аукционе, в лагерь сможет поехать слушатель-выпускник (то есть тот, кто закончит в следующем году 11 класс).

## Динамика по времени

До сих пор мы ограничивались анализом финальных показателей по итогам смены. Давайте взглянем на то, как эти числа формировались на протяжении смены.

```{r bal_flow}

ggplot(time, aes(x = creation_day, y = total_money_on_day_end)) +
  geom_line(col = 'tomato') + 
  geom_point() + 
  
  ggtitle("Суммарный баланс пионеров на протяжении смены")+ 
  scale_x_continuous(breaks = function(x) seq(min(x),max(x),1),
                     name = 'Дни августа')  + 
  scale_y_continuous(breaks = function(x) seq(0,25000,1000),
                     name = 'Баланс пионеров') +
  theme_minimal()
```

На общем графике хорошо видны первый и второй аукционы, экзамены и, конечно, финальный магазин.  

Мы уже знаем, что половину доходов пионеров составили начисления за учебу. Посмотрим, как меняются доходы за учебу и за все остальные активности с течением времени.

```{r bal_flow2}
time = time %>% mutate(flag = 1)
time_styd = time %>% mutate(flag = 0, Все.Учеба =  total_money_on_day_end - Все.Учеба) 

c = bind_rows(time, time_styd)
ggplot(bind_rows(time, time_styd), aes(x = creation_day,y = Все.Учеба, group=flag)) +
  geom_line(aes(col = factor(flag))) + 
  ggtitle("Начисления за учебу и за все остальное")+ 
  scale_x_continuous(breaks = function(x) seq(round(min(x)),max(x),1),
                     name = 'Дни августа')  + 
  scale_y_continuous(breaks = function(x) seq(0,25000,1000),
                     name = 'Сумма начислений') +
  geom_vline(xintercept =  2) + geom_hline(yintercept =  0) + 
  scale_color_discrete(name = "", labels = c("Не учеба", "Учеба"))+
  theme_minimal()
```

На графике четко видно конец учебной недели, когда резко возрастает объем начислений за учебу (за счет экзамена и олимпиад), но падает за все остальное, (в выходные начисляются не очень много баксов за спортивные и вечерние мероприятия).

До сих пор, говоря о доходе, мы имели в виду суммарное изменение баланса, но на самом деле изменения складываются из доходов и расходов. Отложим их на графике по отдельности.

```{r bal_flow3}
time = time %>% mutate(flag = 1)
time_rev = time %>% mutate(flag = 0, total_money_change =  outcome_money) 
time_def = time %>% mutate(flag = 2, total_money_change =  income_money) 

ggplot(bind_rows(time, time_rev,time_def ), aes(x = creation_day,y = total_money_change, group=flag)) +
  geom_line(aes(col = factor(flag))) + 
  ggtitle("Составляющие балланса пионеров")+ 
  scale_x_continuous(breaks = function(x) seq(round(min(x)),max(x),1),
                     name = 'Дни августа')  + 
  scale_y_continuous(breaks = function(x) seq(-22000,15000,2000),
                     name = 'Сумма начислений') +
  geom_vline(xintercept =  2) + geom_hline(yintercept =  0) + 
  scale_color_discrete(name = "", labels = c("Расход", "Изменение", "Доход")) + 
  theme_minimal()
```

Все те же события хорошо видны на графиках. Два экзамена, два аукциона, финальный магазин.

И напоследок, рассмотрим изменения балланса каждого пионера в отдельности. Нарисуем 100 линий, отражающих изменения балланса каждого слушателя смены. 

```{r final_plot,  fig.width=12, fig.height=9}
real_money = money %>%
  filter(counted == 'True') %>%
  arrange(creation_timestamp) %>%
  mutate(timestamp = as.POSIXct(creation_timestamp, format = "%d.%m.%Y %H:%M")) %>%
  select(receiver_username, value, timestamp)

grouped_m = group_by(real_money,receiver_username)
balances_flow = mutate(grouped_m, bal = cumsum(value))


# plotting
plot = ggplot(balances_flow,aes(x = timestamp,y = bal, group = receiver_username )) + 
  geom_line(size = .2,alpha = .3, col = 'black') + 
  geom_point(size = .2,alpha = .3, col = 'black') + 
  geom_hline(yintercept = 0, col = 'red') + 
  scale_x_datetime(date_breaks="1 days", 
                   labels = function(x) strftime(x,format = "%d"),
                   name = 'Дни Августа') + 
  scale_y_continuous(name = 'Баланс слушателя',
                     breaks = seq(-150,1100,50)) + 
  theme_minimal()
plot
```

```{r bal_flow4, eval=FALSE}
# Этот кусок строит зарядки лабы и факультативы от времени, но в нем много ошибок, так что я решил его не включать. 

counters = read.csv('../data/counters.csv',sep=',', stringsAsFactors=FALSE, encoding = "UTF-8")
counters = as_data_frame(counters) %>%
  filter(counted == 'True', receiver_username != 'pioner_bankir' ) %>%
  mutate(creation_day = as.numeric(substr(date, 0, 2))) %>%
  arrange(creation_day)

counter_features = counters %>%
  group_by(creation_day, type_readable_name) %>%
  summarise(value = sum(value))


counter_features = counter_features %>% filter(type_readable_name %in% c("Посещение семинара", "Зарядка", "Отчет по лабораторной работе"), creation_day <= 23, creation_day>=2)
ggplot(counter_features, aes(x = creation_day, y = value)) +
  geom_bar(stat = 'identity',position = 'dodge', aes(fill = factor(type_readable_name))) + 
  ggtitle("Посещения")+ 
  scale_x_continuous(breaks = function(x) seq(round(min(x)),max(x),1),
                     name = 'Дни августа')  + 
  scale_y_continuous(breaks = function(x) seq(0,170,5),
                     name = 'Количество посещений') +
   geom_hline(yintercept =  0) + 
  scale_fill_discrete(name = "Мероприятие", labels = c("Семинар", "Зарядка", "Лаборатория")) + 
  theme_minimal()

#
#Этот график, к сожалению, содержит некоторое количество не совсем достоверных данных, потому что большое количество #транзакций попадало в банк не сразу или заносилось с ошибками. Например, на графике мы видим посещение семинара 19 #августа (суббота) – в выходной день.
```
_В лушчем качестве изображение доступно по [ссылке](final\_plot.png)_

Вот и все.  
Спасибо за внимание. 

## Приложение

####Коэффиценты корреляции и значения p-value для 4 основных статей дохода

```{r add1}
knitr::kable(corr.test(inter)$r, caption = "Коэффиценты корреляции")
knitr::kable(corr.test(inter)$p, caption = "Значения p-value")
```

#### Все рассмотренные типы транзакций. 

В названиях типа префиксы, "Общие" и "Частные" означают группирующие типы. Так например тип "Общие Учеба" включает в себя типы "Частные Обязательная учебная программа" и "Частные Необязательная учебная программа", а каждый из них включает в себя все остальные типы относящиеся к классу "Учеба"


```{r add2}
colnames(type) <- c("#","Название типа","Количество","Среднее занчение","Количество элементарных начислений","Сумма","Максимум",'Минимум','Медиана','Среднее')
knitr::kable(type)
```
